{% extends 'base.html' %}
{% load  custom static %}
{% block page-container %}

    <div class="wrap-left">
        <!-- 标题 作者信息 发布时间 评论 -->
        <div class="article-title-bg">{{ article_obj.title }}</div>
        <div class="article-title-brief">
            <span>作者:{{ article_obj.author.name }}</span>
            <span>发布时间:{{ article_obj.pub_date }}</span>
            <span>
                {% filter_comment article_obj as comments %}
                评论数:{{ comments.comment_count }}
                点赞数:{{ comments.thumb_count }}
            </span>
        </div>
        <!-- 文字内容 -->
        <div class="article-content">
            {% truncate_url article_obj.head_img.url as imgpath %}
            <img class="article-detail-head-img" src="{% static imgpath %}"/>
            {{ article_obj.content }}
        </div>
        <!-- 评论框 -->
        <div class="comment-box">
            {% if request.user.is_authenticated %}
                <textarea class="form-control" rows="4"></textarea>
                <button class="btn btn-sm btn-primary pull-right" style="margin-top:10px;">评论</button>
            {% else %}
                <div class="jumbotron" style="text-align: center">
                    <h4><a class="btn-link" href="{% url 'login' %}?next={{ request.path_info }}">登录</a>后再评论!</h4>
                </div>
            {% endif %}
        </div>


    </div>
    <div class="wrap-right">
        right
    </div>
{% endblock %}

{% block script-container %}
    <script>
        function getcsrf() {
            var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();
            return csrftoken;
        }

        //当页面的文字等都加载完成后，执行这个
        $(document).ready(function () {
            $('.comment-box button').click(function () {
                var comment_text = $('.comment-box textarea').val();
                if (comment_text.trim().length < 5) {            //当文字少于5时，trim()是用于去除输入前后的空格，相当于Python的strip
                    alert('评论不能少于5个字符')
                } else {
                    $.post(
                        "{% url 'post_comment' %}",
                        {
                            comment_type: 1,
                            article_id: '{{ article_obj.id }}',
                            parent_comment_id: null,
                            comment: comment_text.trim(),
                            csrfmiddlewaretoken: getcsrf(),
                        },
                        function (callback) {
                            if(callback == 'ok'){
                                alert(comment_text);
                            }
                        }
                    )
                }

            })
        })
    </script>

{% endblock %}